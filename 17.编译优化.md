### 编译优化

#### 动态节点收集与补丁标志

#### Block

#### 静态提升
> 纯静态的虚拟节点在更新时也会被重新创建一次。这是没有必要的，因此需要想办法避免由此带来的性能开销；
>   解决方法就是”静态提升“，即把纯静态的节点提升到渲染函数之外。
> 当响应式数据发生改变，并使得渲染函数重新执行时，并不会重新创建静态的虚拟节点，从而避免额外性能开销。
```javascript
// 提升前
function render (ctx) {
  return (openBlock(), createBlock('div', null, [
    createVNode('p', null, 'static text'),
    createVNode('p', null, ctx.title, 1)
  ]))
}

// 提升后
const hoist1 = createVNode('p', null, 'text') // 将静态节点提升到函数之外
function render (ctx) {
  return (openBlock(), createBlock('div', null, [
    hoist1, // 静态节点引用
    createVNode('p', null, ctx.title, 1)
  ]))
}
// props 也可以被提升
const hoistProp = { foo: 'bar', a: 'b' }
function render (ctx) {
  return (openBlock(), createBlock('div', null, [
    createVNode('p', hoistProp, ctx.text)
  ]))
}
```

#### 预字符串化
> 预字符串化时基于静态提升的一种优化策略。  
> 静态提升的虚拟节点或虚拟节点树本身是静态的，可以将这些静态节点序列化为字符串，并生成一个Static类型的vNode。  

#### 缓存内联事件处理函数
`<Comp @change="a + b""></Comp>`  
 这段代码的change事件是通过内敛语句绑定的，这样编译器每次重新渲染时，都会为其创建一个全新的props对象，
    同时props中的 onChange 也是全新的函数。造成额外的性能开销。为了避免这些无用的更新，需要对内联事件
    处理函数进行缓存
```javascript
function render (ctx, cache) {
  return h(Comp, {
    // 将内联事件处理函数缓存到cache中
    onChange: cache[0] || (cache[0] = ($event) => (ctx.a + ctx.b))
  })
}
```
> 渲染函数的第二个参数是一个数组 cache，该数组来自组件实例，可以把内敛事件处理函数添加到cache中。

#### v-once
**避免组件更新时重新创建虚拟DOM带来的性能开销。因为虚拟DOM被缓存了，所以更新无需重新创建**  
**避免无用的Diff开销。因为被v-once标记的虚拟DOM树不会被父级Block节点收集**  

```javascript
const template = `
  <section>
    <div v-once>{{ foo }}</div>
  </section>
`
// 上面模板将会被编译为该render函数
function render (ctx, cache) {
  return (openBlock(), createBlock('div', null, [
    cache[1] || (cache[1] = createVNode('div', null, ctx.foo, 1) /* Text */ )
  ]))
}
```
后续更新导致渲染函数重新执行时，会优先读取缓存的内容，而不会重新创建虚拟节点。  
虚拟节点被缓存，因此不需要这些缓存的虚拟节点参与Diff操作。所以：
```javascript
// 实际编译后的代码
function render(ctx, cache) {
  return (openBlock(), createBlock('div', null, [
    cache[1] || (
      setBlockTracking(-1), // 阻止这段 VNode 被 Block 收集
      cache[1] = h('div', null, ctx.foo, 1),
      setBlockTracking(1), // 恢复
      cache[1] // 整个表达式的值
    )
  ]))
}
```

