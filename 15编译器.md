### 编译器
**AST：即抽象语法树**  
**编译器将源代码翻译为目标代码的过程叫做编译**  
**vueJS模板编译器的目标代码其实就是渲染函数**  
编译阶段
 - 编译前端：包括词法分析、语法分析和语义分析，通常与平台无关，仅负责分析源代码
 - 编译中端：后端的中间代码生成和优化有时也可以称为中端
 - 编译后端：中间代码生成和优化、目标代码生成

代码编译过程：
源代码 -->
词法分析 --> 语法分析 --> 语义分析 -->
中间代码生成 --> 优化 --> 目标代码生成 -->
目标代码

编译流程：
模板 -->
词法分析 --> 语法分析 --> 模板AST --> Transformer -->
JavaScript AST --> 代码生成 --> 渲染函数

#### 编译器特点
```javascript
const template = `
<div>
    <h1 v-if="ok">Vue Template</h1>
</div>
`
const ast = {
  // 逻辑根节点
  type: 'Root',
  children: [
    // div标签节点
    {
      type: 'Element',
      children: [
        // h1标签节点
        {
          type: 'Element',
          tag: 'h1',
          props: [
            // v-if指令节点
            {
              type: 'Directive', // 类型为Directive代表指令
              name: 'if', // 指令名称为if，不带有前缀v-
              exp: {
                // 表达式节点
                type: 'Expression',
                content: 'ok'
              }
            }
          ]
        }
      ]
    }
  ]
}
```

根据上面例子可以得到编译器拥有的部分特点
 - 不同类型的节点使通过节点的type属性进行区分的。例如标签节点的type值为'Element'
 - 标签节点的子节点存储在其children数组中
 - 标签节点的属性节点和指令节点会存储在props数组中
 - 不同类型的节点会使用不同的对象属性进行描述。例如指令节点拥有name属性，用来表达指令的名称，
  而表达式节点拥有content属性，拥有描述表达式的内容

```javascript
const template = `
<div>
    <h1 v-if="ok">Vue Template</h1>
</div>
`
const templateAST = parse(template)
const jsAST = transform(templateAST)
const code = generator(jsAST)
```

通过parse将解析得到模板AST。有了模板AST就可以对其进行语义分析，并将模板AST转换为用来描述渲染函数的JavaScript AST。  
得到JavaScript AST，就可以根据它生成渲染函数，可以通过封装generator函数来完成。  
generator函数会将渲染函数的代码以字符串的形式返回，并保存到code中。  

template --> parse(template) --> template AST
template AST --> transform(AST) --> JavaScript AST
JavaScript AST --> generate(AST) --> 渲染函数

#### AST的转换与插件化架构(TODO)

> 插件化架构：实现transform时将具体的操作抽离出来，而不是作为核心实现的一部分
```typescript
function transform (root, options) {
  const context = createTransformContext(root, options)

  // 1.遍历 - 深度优先搜索
  traverseNode(root, context)
  // 2.修改text content
}

function createTransformContext (root: any, options: any) {
  const context = {
    root,
    nodeTransforms: options.nodeTransforms || []
  }
  return context
}
function traverseNode (node: any, context) { 
   // 被抽离到外部
   // if (node.type === NodeTypes.TEXT) {
   //   node.content = node.content + ' mini-vue'
   // }
   const nodeTransforms = context.nodeTransforms
   for (let i = 0; i < nodeTransforms.length; i++) {
     const transform = nodeTransforms(i)
     transform(node)
   }
 
   // traverseChildren(node, context)
 }

 // use
const plugin = node => {
  if (node.type === NodeTypes.TEXT) {
    node.content = node.content + ' mini-vue'
  }
}

transform(ast, {
  nodeTransforms: [plugin]
})
```

##### 节点的访问

